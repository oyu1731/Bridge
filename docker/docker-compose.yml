# Docker Composeファイル
# このファイルは、アプリケーションを構成する複数のDockerコンテナ（サービス）を定義し、
# それらの連携方法を設定します。
#
# チームメンバーへ:
#   - `docker-compose up` コマンドで、ここで定義されたサービス（MySQLとSpring Bootバックエンド）が起動します。
#   - `frontend` サービスは、Flutterのホットリロードをローカルで利用するためにコメントアウトされています。
#     Docker環境でFlutterも起動したい場合は、`frontend` サービスのコメントを解除してください。
#
version: '3.8'

services:
  # MySQLデータベースサービス
  # Spring Bootバックエンドが利用するデータベースです。
  mysql:
    image: mysql:8.0 # MySQL 8.0の公式イメージを使用
    container_name: bridge-mysql # コンテナの名前
    environment: # 環境変数でMySQLの認証情報を設定
      MYSQL_ROOT_PASSWORD: rootpassword # rootユーザーのパスワード
      MYSQL_DATABASE: bridgedb # 作成するデータベース名
      MYSQL_USER: bridgeuser # アプリケーションが使用するユーザー名
      MYSQL_PASSWORD: bridgepass # アプリケーションが使用するパスワード
    ports:
      - "3306:3306" # ホストの3306ポートをコンテナの3306ポートにマッピング
    volumes:
    - mysql_data:/var/lib/mysql
    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf


    networks:
      - bridge-network # サービス間の通信に使用するネットワーク
    restart: unless-stopped # コンテナが停止した場合に自動的に再起動
    healthcheck: # サービスが正常に動作しているかを確認するヘルスチェック
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      timeout: 20s
      retries: 10
      start_period: 30s

  # Spring Bootバックエンドサービス
  # FlutterアプリケーションからのAPIリクエストを処理します。
  backend:
    build: # Dockerfileからイメージをビルド
      context: ../backend # ビルドコンテキストのパス
      dockerfile: ../docker/Dockerfile.backend # 使用するDockerfileのパス
    container_name: bridge-backend # コンテナの名前
    env_file:
      - .env
    ports:
      - "8080:8080" # ホストの8080ポートをコンテナの8080ポートにマッピング
    depends_on: # 依存関係の定義
      mysql:
        condition: service_healthy # MySQLが正常に起動してからbackendを起動
    environment: # 環境変数でSpring Bootの設定を上書き
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/bridgedb # データベース接続URL (Dockerネットワーク内のmysqlサービス名を使用)
      SPRING_DATASOURCE_USERNAME: bridgeuser # データベースユーザー名
      SPRING_DATASOURCE_PASSWORD: bridgepass # データベースパスワード
    volumes:
      - uploaded_photos:/app/uploads/photos # 画像アップロード用の永続化ボリューム
    networks:
      - bridge-network # サービス間の通信に使用するネットワーク
    restart: unless-stopped # コンテナが停止した場合に自動的に再起動
    healthcheck: # サービスが正常に動作しているかを確認するヘルスチェック
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"] # Spring Boot Actuatorのヘルスエンドポイントを使用
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

# frontend: # Flutterのホットリロードをローカルで利用するため、このサービスはコメントアウトされています。
#   # Docker環境でFlutterも起動したい場合は、以下のコメントを解除してください。
#   # build:
#   #   context: ../frontend
#   #   dockerfile: ../docker/Dockerfile.frontend
#   # container_name: bridge-frontend
#   # ports:
#   #   - "5000:5000"
#   # depends_on:
#   #   - backend
#   # networks:
#   #   - bridge-network
#   # restart: unless-stopped
#   # volumes:
#   #   - ../frontend:/app          # ローカルコードをコンテナにマウント (ホットリロード用)
#   # command: flutter run -d web-server --web-port=5000 --web-hostname=0.0.0.0 # Flutter開発サーバーを起動
#   # stdin_open: true # 標準入力を開く (Flutter runに必要)
#   # tty: true # TTYを割り当てる (Flutter runに必要)

volumes:
  mysql_data: # MySQLデータ用のボリューム定義
  uploaded_photos: # アップロードされた画像ファイル用のボリューム定義

networks:
  bridge-network: # サービス間の通信に使用するカスタムネットワーク
    driver: bridge